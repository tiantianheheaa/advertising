- 转化归因：https://support.e.qq.com/detail?cid=4595&pid=10217
- callback字段：https://datanexus.qq.com/doc/develop/guider/interface/conversion/ad_track_click


<img width="908" height="286" alt="image" src="https://github.com/user-attachments/assets/405c98f2-44e3-4cc9-b929-129c8086778d" />
<img width="1596" height="538" alt="image" src="https://github.com/user-attachments/assets/37310796-daf3-40cf-a6f7-a56f77a9bbe2" />


### 广告场景中 `callback` 参数的使用流程示例

#### 1. **场景描述**
腾讯广告平台在广告点击时，会通过回调（callback）向广告主服务器下发一个 `callback` 参数，该参数是 **URL 编码后的字符串**。广告主服务器需要记录此参数，并在后续自归因数据上报时，将其 **解码后** 作为 POST 请求的 URL 回传给腾讯广告。

#### 2. **关键注意事项**
- 腾讯下发的 `callback` 是 **原始 URL 编码值**（例如 `key%3Dvalue%26name%3Dtest`）。
- 部分 HTTP 库（如 Python 的 `requests`、Java 的 `HttpURLConnection`）会**自动对 URL 进行一次解码**，因此需避免重复解码，否则会导致参数错误。

---

### 具体流程示例

#### **步骤 1：腾讯下发 `callback` 参数**
假设用户点击广告后，腾讯广告平台通过重定向向广告主服务器发送请求：
```
https://advertiser.com/click?callback=key%253Dvalue%2526name%253Dtest
```
- **注意**：实际下发的 `callback` 可能是 **双重编码**的（如 `key%253Dvalue` 是 `key=value` 的双重编码），但根据描述，这里假设是单层编码 `key%3Dvalue%26name%3Dtest`。

#### **步骤 2：广告主服务器接收并存储 `callback`**
广告主服务器收到请求：
```
GET /click?callback=key%3Dvalue%26name%3Dtest
```
- 直接摘取 `callback` 的原始值（**不解码**），存储为：  
  `callback_raw = "key%3Dvalue%26name%3Dtest"`

#### **步骤 3：自归因数据上报时回传**
当触发上报逻辑时，广告主服务器需将 `callback` 解码后作为 POST 请求的 URL 参数回传。  
假设上报接口为 `https://analytics.qq.com/track`，需将 `callback` 解码为 `key=value&name=test` 并附加到 URL：

1. **手动解码**（如果 HTTP 库不自动解码）：
   ```python
   import urllib.parse
   callback_decoded = urllib.parse.unquote("key%3Dvalue%26name%3Dtest")
   # 结果: "key=value&name=test"
   ```
   上报 URL 为：  
   `https://analytics.qq.com/track?callback=key=value&name=test`

2. **如果 HTTP 库自动解码**（如某些库会预处理 URL 参数）：
   - 直接使用原始 `callback_raw`，由库自动处理解码，避免手动解码导致重复解码错误。

---

### URL Encode 和 URL Decode 的解释

#### **URL Encode（编码）**
- **作用**：将特殊字符（如 `=`, `&`, `空格`, `中文` 等）转换为 `%` 开头的十六进制格式，确保 URL 传输安全。
- **示例**：
  - 原始字符串：`key=value&name=test`
  - 编码后：`key%3Dvalue%26name%3Dtest`
    - `=` → `%3D`
    - `&` → `%26`

#### **URL Decode（解码）**
- **作用**：将 `%XX` 格式的编码字符还原为原始字符。
- **示例**：
  - 编码字符串：`key%3Dvalue%26name%3Dtest`
  - 解码后：`key=value&name=test`

---

### 常见问题：重复解码的错误
如果 HTTP 库自动解码且代码又手动解码了一次：
1. 原始 `callback`：`key%3Dvalue%26name%3Dtest`（编码后的 `key=value&name=test`）。
2. 库自动解码为：`key=value&name=test`。
3. 代码又手动解码一次，`&` 和 `=` 会被错误处理（如被拆分成多个参数）。

**错误结果**：  
上报的 `callback` 参数可能被截断为 `key`，导致腾讯无法正确识别。

---

### 总结
1. **接收阶段**：直接存储腾讯下发的原始 `callback`（如 `key%3Dvalue%26name%3Dtest`）。
2. **上报阶段**：
   - 如果 HTTP 库**不自动解码**，需手动解码后回传。
   - 如果 HTTP 库**自动解码**，直接使用原始值，避免重复操作。
3. **核心原则**：确保最终上报的 `callback` 是 **单层解码后的原始参数**（如 `key=value&name=test`）。
